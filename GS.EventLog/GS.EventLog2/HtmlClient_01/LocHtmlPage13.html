<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>EventLogItems with Bootstrap</title>
    
    <link href="Content2/bootstrap.css" rel="stylesheet" />
    <link href="Content2/bootstrap-responsive.css" rel="stylesheet" />

    <script src="Scripts2/jquery-1.9.1.min.js"></script>
    <script src="Scripts2/underscore-min.js"></script>

    <script src="Scripts2/bootstrap.js"></script>
    <script src="Scripts2/jsrender.js"></script>
    
    <script src="Scripts2/knockout.js"></script>
    <script src="Scripts2/knockout.mapping-latest.js"></script>
    <script src="Scripts2/gs.js"></script>

    
    <script  type="text/javascript">
        $(function () {
            var self = this;
            function ViewModelPage() {

                this.pageSize = ko.observable(25);
                this.pageCurrent = ko.observable(1);
                //  this.pageCount = ko.observable(0);

                this.recordCount = ko.observable(0);

                this.autoMode = ko.observable('Manual');
                this.setMode = function (mode) {
                    if (mode === 'Auto' && this.autoMode() !== mode) {
                        this.autoMode(mode);
                        fnnGetDataT();
                    }
                    else if (this.autoMode() === 'Auto' && mode !== 'Auto')
                        this.autoMode(mode);
                };

                this.sortOrder = ko.observable('desc');
                this.setSortOrder = function (sort) {
                    if (this.sortOrder() !== sort) {
                        this.sortOrder(sort);
                        fnnGetData();
                    }
                };

                this.addPageSize = function (n) {
                    var val = this.pageSize() + n;
                    val > 0 ? this.pageSize(val) : this.pageSize(1);
                    // this.pageSize(this.pageSize() + n);
                };

                this.addPageCurrent = function (n) {

                    var crnt = this.pageCurrent();
                    /*
                    if (isNumeric(crnt)) {
                        crnt = crnt;
                    } else {
                        crnt = parseInt(crnt);                        
                    }                    
                    var val = crnt + n;
                    */
                    if (_.isString(crnt)) {
                        crnt = parseInt(crnt, 10);
                    }
                    //var val = this.pageCurrent() + n;
                    var val = crnt + n;
                    val > 0
                        ? (val <= this.pageCount()
                            ? this.pageCurrent(val)
                            : this.pageCurrent(this.pageCount()))
                        : this.pageCurrent(1);

                    //this.pageCurrent(this.pageCurrent() + n);
                };

                this.requestStr = ko.computed(function () {
                    if (this.pageCurrent() <= 0) {
                        this.pageCurrent(1);
                    }
                    if (this.pageSize() <= 0) {
                        this.pageSize(25);
                    }

                    var rskip = (this.pageCurrent() - 1) * this.pageSize();
                    var rtop = this.pageSize();

                    return "http://localhost/WebEventLog_02/odata/OdataEventLogItems" +
                        "?$skip=" + rskip + "&$top=" + rtop + "&$orderby=DT " + this.sortOrder();
                }, this);

                this.pageCount = ko.computed(function () {

                    if (this.pageSize() <= 0) {
                        this.pageSize(25);
                    }

                    var val = this.recordCount() / this.pageSize();
                    val = Math.ceil(val);

                    return val;
                }, this);


            }

            window.vm = new ViewModelPage();
            ko.applyBindings(vm);

            window.evl = new EventLog('#LogOutput', true);
            evl.addLogItem('Hello from GS.EventLog');

            window.requester = new Requester3(undefined, undefined, undefined);
            /*
            requester.getData("http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                   function (data) {
                       vm.recordCount(data);
                       evl.preaddLogItem("Success - GetCount:=" + data.toString());
                   },
                   function () {
                       evl.preaddLogItem("Error - GetCount Failure");
                   }
               );
               */

            /*
            fnGetCount();
            var str = vm.requestStr();
            fnGetAjax(str);
            */
            fnnGetData();
            //  fnnGetDataT();
        });


    </script>

</head>
    <body>
        <div class="btn-toolbar input-append">
            <div class="btn-group pull-left">
                <button class="btn-small" onclick="window.vm.pageCurrent(1);fnnGetData();"><strong>First</strong></button>
                <button class="btn-small" onclick="window.vm.addPageCurrent(-1);fnnGetData();"><strong>Previous</strong></button>
                <button class="btn-small" onclick="fnnGetData();"><strong>Current:</strong></button>
                <input class="input-mini" type="number" data-bind="value: pageCurrent"/>
                <!--
                    <button class="btn-primary btn-small" onclick="fnOnClickGo()"><strong>Go!</strong></button>
                    -->
                <button class="btn-small" onclick="fnnGetData();"><strong>Size:</strong></button>
                <input class="input-mini btn-small" type="number" data-bind="value: pageSize" />
                <button class="btn-small" onclick="window.vm.addPageCurrent(+1);fnnGetData();"><strong>Next</strong></button>
                <button class="btn-small" onclick="window.vm.pageCurrent(window.vm.pageCount());fnnGetData();"><strong>Last</strong></button>
            </div>
            <div class="btn-group">
                <button class="btn-small" onclick="vm.setMode('Auto');"><strong>Auto</strong></button>
                <button class="btn-small" onclick="vm.setMode('Manual');"><strong>Manual</strong></button>
            </div>
            <div class="btn-group">
                <button class="btn-small" onclick="vm.setSortOrder('asc');"><strong>Asc</strong></button>
                <button class="btn-small" onclick="vm.setSortOrder('desc');"><strong>Desc</strong></button>
            </div>
            
        </div>
        <div>
            <span>Total <strong data-bind="text: recordCount"></strong> Records in <strong data-bind="    text: pageCount"></strong> Pages with Size <strong data-bind="    text: pageSize"></strong> Records</span>
            <span>Mode: <strong data-bind="text: autoMode"></strong></span>
            <span>Request: <strong data-bind="text: requestStr"></strong></span>
        </div>
        <!--
            <span>Page Size: <strong data-bind="text: pageSize"></strong></span>
            <span>Page Current: <strong data-bind="text: pageCurrent"></strong></span>
            -->
        
        <div class="row-fluid ">
            <table class="table table-bordered table-condensed">
                <thead>
                    <tr class="label-info"><th>ID</th>
                        <th>DateTime</th>
                        <th>Result</th>
                        <th>Subject</th>
                        <th>Source</th>
                        <th>Entity</th>
                        <th>Operation</th>
                        <th>Description</th>
                        <th>Object</th>
                        <th>EventLogID</th>
                    </tr>
                </thead>

                <tbody id="eventLogItemList"></tbody>

            </table>
        </div>
        <div id="LogOutput"></div>

        <script type="text/javascript">

            $.templates({
                titleTemplate: "<tr><td colspan=3>{{>Name}}</td></tr>",
                detailTemplate: "<tr><td>{{>EventLogItemID}}</td><td>{{>Name}}</td><td>Alias: {{>Alias}}</td><td>Description: {{>Description}}</td></tr>",
                detailEvlItemTemplate:
                    /*
                    "{{if ResultCode === 'FATAL'}}" + 
                    "<tr class='label-warning'>" +
                     "{{else}}" +
                    "<tr class='label-info'>" +
                     "{{/if}}"   +
                     */
                    "<tr>" +
                        "<td>{{:EventLogItemID}}</td>" +
                        "<td>{{:DT}}</td>" +
                        "{{if ResultCode === 'FATAL'}}" +
                        "<td class='label-warning'>{{:ResultCode}}</td>" +
                        "{{else}}" +
                        "<td class='label-info'>{{:ResultCode}}</td>" +
                        "{{/if}}" +
                        //  "<td>{{:ResultCode}}</td>" +
                        "<td>{{:Subject}}</td>" +
                        "<td>{{:Source}}</td>" +
                        "<td>{{:Entity}}</td>" +
                        "<td>{{:Operation}}</td>" +
                        "<td>{{:Description}}</td>" +
                        "<td>{{:Object}}</td>" +
                        "<td>{{:EventLogID}}</td>" +
                        "</tr>"
            });
        </script>
        
        <script type="text/javascript">
            /* 
                 function ViewModelPage() {
                     this.pageSize = ko.observable(50);
                     this.pageCurrent = ko.observable(1);
                     this.pageCount = ko.observable(0);
     
                     this.recordCount = ko.observable(0);
     
                     this.requestStr = ko.computed(function () {
                         var rskip = (this.pageCurrent() - 1) * this.pageSize();
                         var rtop = this.pageSize();
                         return "http://81.176.229.34/ODataEventLog/odata/EventLogItems" +
                             "?$skip=" + rskip + "&$top=" + rtop;
                     }, this);
                 }
     
                 var vm = new ViewModelPage();
                 ko.applyBindings(vm);
                 */
        </script>
        
        <script type="text/javascript">

            function fnOnClickGo() {
                var str = vm.requestStr();
                fnGetAjax(str);
            }

            function fnGetAjax(request) {
                //  alert(request);
                $.ajax({
                    type: 'GET',
                    url: request,
                    dataType: 'json',
                    success: function (data) {
                        var arr = data.value;
                        $("#eventLogItemList").html($.render.detailEvlItemTemplate(arr));
                    },
                    error: function () {
                        alert("Error in Ajax Data Receving");
                    }
                });
            }

            function fnnGetData() {
                requester.getData("http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                    function (data) {
                        vm.recordCount(data);
                        evl.preaddLogItem("Success - GetCount:=" + data.toString());

                        var str = vm.requestStr();
                        requester.getData(
                            str,
                            function (data2) {
                                var arr = data2.value;
                                evl.preaddLogItem("Success - GetDataCount: " + arr.length.toString());
                                $("#eventLogItemList").html($.render.detailEvlItemTemplate(arr));
                            },
                            function () {
                                evl.preaddLogItem("Error - GetData Failure");
                            });
                    },
                    function () {
                        evl.preaddLogItem("Error - GetCount Failure");
                    }
                );
            }
            function fnnGetDataT() {
                requester.getData("http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                    function (data) {
                        //  vm.recordCount(data);
                        evl.preaddLogItem("Success - GetCount:=" + data.toString());
                        if (data === vm.recordCount()) {
                            if (vm.autoMode() === 'Auto')
                                setTimeout(fnnGetDataT, 5000);
                            return;
                        }
                        vm.recordCount(data);
                        if (vm.sortOrder() === 'desc')
                            vm.pageCurrent(1);
                        else
                            vm.pageCurrent(vm.pageCount());

                        var str = vm.requestStr();
                        requester.getData(
                            str,
                            function (data2) {
                                var arr = data2.value;
                                $("#eventLogItemList").html($.render.detailEvlItemTemplate(arr));
                                evl.preaddLogItem("Success - GetDataCount: " + arr.length.toString());
                                if (vm.autoMode() === 'Auto')
                                    setTimeout(fnnGetDataT, 5000);
                            },
                            function () {
                                evl.preaddLogItem("Error - GetData Failure");
                                if (vm.autoMode() === 'Auto')
                                    setTimeout(fnnGetDataT, 5000);
                            });
                    },
                    function () {
                        evl.preaddLogItem("Error - GetCount Failure");
                        if (vm.autoMode() === 'Auto')
                            setTimeout(fnnGetDataT, 5000);
                    }
                );
            }

            function fnGetCount() {
                requester.getData("http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                    function (data) {
                        vm.recordCount(data);
                        evl.preaddLogItem("Success - GetCount:=" + data.toString());
                    },
                    function () {
                        evl.preaddLogItem("Error - GetCount Failure");
                    }
                );

                //  alert(request);
                /*
                $.ajax({
                    type: 'GET',
                    url: "http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                    dataType: 'json',
                    success: function (data) {
                        //  vm.pageCount(data / vm.pageSize() + 1);
                        vm.recordCount(data);
                        //  alert(data);
                    },
                    error: function () {
                        alert("Error in Count Data Receving");
                    }
                });
                */
            }

            function fnGetData01() {
                //  alert(request);
                $.ajax({
                    type: 'GET',
                    url: "http://localhost/WebEventLog_02/api/eventlogitems?par=count",
                    dataType: 'json',
                    success: function (count) {
                        //  vm.pageCount(data / vm.pageSize() + 1);
                        if (count === vm.recordData()) {
                            return;
                        }
                        vm.recordCount(count);
                        fnOnClickGo();

                        //  alert(data);
                    },
                    error: function () {
                        alert("Error in Count Data Receving");
                    }
                });
            }

        </script>

    </body>
</html>


